name: Build and Release Linux

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v6

    - name: Check for Existing Linux Asset
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 1. Extract Version from Cargo.toml
        VERSION=$(awk -F '[""]' '/^version/ { print $2; exit }' Cargo.toml)
        TAG_NAME="v$VERSION"
        TARGET_ASSET="phdupes-v${VERSION}-linux"

        echo "Checking for asset: $TARGET_ASSET in release $TAG_NAME"

        # 2. Check if release exists
        if gh release view "$TAG_NAME" > /dev/null 2>&1; then
            echo "Release $TAG_NAME exists. Checking assets..."

            # 3. Check if specific file exists in the asset list
            if gh release view "$TAG_NAME" --json assets -q '.assets[].name' | grep -F -x "$TARGET_ASSET"; then
                echo "::error::Asset '$TARGET_ASSET' already exists in release $TAG_NAME. Aborting."
                exit 1
            else
                echo "Release exists but Linux asset is missing. Proceeding to build."
            fi
        else
            echo "Release $TAG_NAME does not exist. Proceeding to build."
        fi

        # 4. Export VERSION for later steps
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Free Disk Space
      run: |
        df -Th /
        echo nuke android
        sudo rm -rf /usr/local/lib/android
        df -Th /
        echo nuke dotnet
        sudo rm -rf /usr/share/dotnet
        df -Th /
        echo nuke haskell
        sudo rm -rf /usr/local/.ghcup /opt/ghc
        echo nuke docker
        sudo docker image prune --all --force || true
        echo finished, did it help?
        df -Th /

    - name: Install Build Tools & Codecs
      run: |
        sudo apt-get update
        sudo apt remove -y dav1d libdav1d-dev libaom3 libaom-dev
        sudo apt-get install -y \
          cmake meson ninja-build build-essential \
          pkg-config libssl-dev libde265-dev libx265-dev libopenjp2-7-dev libnuma-dev \
          libjpeg-dev libgtk-3-dev libxkbcommon-dev libwayland-dev nasm libxxhash-dev

    # get gcc specs
    - name: GCC specs
      run: |
        gcc --version
        gcc -dumpspecs
        touch /tmp/gcctest.c && gcc -v /tmp/gcctest.c -c

    - name: Install Static libde265
      run: |
        LIBDE265_HASH="b92beb6b53c346db9a8fae968d686ab706240099cdd5aff87777362d668b0de7"
        LIBDE265_VERSION="1.0.16"
        wget -q -t 30 --waitretry 10 -O libde265-"${LIBDE265_VERSION}".tar.gz https://github.com/strukturag/libde265/releases/download/v"${LIBDE265_VERSION}"/libde265-"${LIBDE265_VERSION}".tar.gz
        echo "${LIBDE265_HASH}  libde265-${LIBDE265_VERSION}.tar.gz" | sha256sum --check
        tar -zxf libde265-${LIBDE265_VERSION}.tar.gz
        cd libde265-${LIBDE265_VERSION}
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
          -DCMAKE_BUILD_TYPE=Release

        make -j$(nproc)
        sudo make install

    # Compile libaom from source (STATIC)
    - name: Build libaom 3.13.1
      run: |
        AOM_VERSION="3.13.1"
        wget -q -t 30 --waitretry 10 -O aom-${AOM_VERSION}.tar.gz https://aomedia.googlesource.com/aom/+archive/v${AOM_VERSION}.tar.gz#/aom-${AOM_VERSION}.tar.gz
        AOM_TS=$(date +%s)
        echo "EXT_AOM_VER=${AOM_VERSION}" >> $GITHUB_ENV
        echo "EXT_AOM_HASH=Unknown:ts=$AOM_TS" >> $GITHUB_ENV

        mkdir aom-${AOM_VERSION}
        cd aom-${AOM_VERSION}
        tar -zxf ../aom-${AOM_VERSION}.tar.gz
        find . -type f -printf '%s %p\n'
        mkdir aom_build
        cd aom_build
        cmake -DCMAKE_INSTALL_PREFIX=/usr \
              -DBUILD_SHARED_LIBS=0 \
              -DENABLE_TESTS=0 \
              -DENABLE_DOCS=0 \
              -DENABLE_EXAMPLES=0 \
              -DENABLE_TOOLS=0 \
              -DCONFIG_AV1_ENCODER=1 \
              -DCONFIG_AV1_DECODER=1 \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCONFIG_WEBM_IO=1 \
              ..
        make -j$(nproc)
        sudo make install

    # Compile libdav1d from source (STATIC)
    - name: Build dav1d 1.5.3
      run: |
        DAV1D_HASH="e099f53253f6c247580c554d53a13f1040638f2066edc3c740e4c2f15174ce22"
        DAV1D_VERSION="1.5.3"
        wget -q -t 30 --waitretry 10 https://code.videolan.org/videolan/dav1d/-/archive/${DAV1D_VERSION}/dav1d-${DAV1D_VERSION}.tar.bz2
        echo "${DAV1D_HASH}  dav1d-${DAV1D_VERSION}.tar.bz2" | sha256sum --check
        echo "EXT_DAV1D_VER=${DAV1D_VERSION}" >> $GITHUB_ENV
        echo "EXT_DAV1D_HASH=${DAV1D_HASH}" >> $GITHUB_ENV

        tar -xjf dav1d-${DAV1D_VERSION}.tar.bz2
        cd dav1d-${DAV1D_VERSION}
        export CFLAGS="-fstack-protector-strong -fstack-clash-protection -fcf-protection=full -fPIC"
        export LDFLAGS="-Wl,-z,relro"

        meson setup build --prefix=/usr --libdir=lib/x86_64-linux-gnu --buildtype=release \
          -Ddefault_library=static -Denable_tests=false -Denable_tools=false

        ninja -C build
        sudo ninja install -v -C build
        sudo ldconfig

    - name: Check dav1d version
      run: |
        echo "Checking pkg-config for dav1d..."
        pkg-config --static --libs --cflags dav1d 'dav1d == 1.5.3'

    # Compile libheif from source (STATIC)
    - name: Build libheif 1.21.2
      run: |
        HEIF_HASH="75f530b7154bc93e7ecf846edfc0416bf5f490612de8c45983c36385aa742b42"
        HEIF_VERSION="1.21.2"
        wget -q -t 30 --waitretry 10 https://github.com/strukturag/libheif/releases/download/v${HEIF_VERSION}/libheif-${HEIF_VERSION}.tar.gz
        echo "${HEIF_HASH}  libheif-${HEIF_VERSION}.tar.gz" | sha256sum --check
        echo "EXT_HEIF_VER=${HEIF_VERSION}" >> $GITHUB_ENV
        echo "EXT_HEIF_HASH=${HEIF_HASH}" >> $GITHUB_ENV

        tar -xzf libheif-${HEIF_VERSION}.tar.gz
        cd libheif-${HEIF_VERSION}
        mkdir build
        cd build

        cmake -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release \
          -DWITH_DAV1D=ON -DWITH_OpenJPEG=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON ..

        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Check libheif version
      run: |
        echo "Checking pkg-config for libheif..."
        pkg-config --static --libs --cflags libheif 'libheif == 1.21.2'

    - name: Install Rust 1.93.0
      uses: dtolnay/rust-toolchain@1.93.0
      with:
        targets: "x86_64-unknown-linux-gnu"

    - name: Build Binary
      env:
        # Forces Rust to link all pkg-config dependencies statically
        PKG_CONFIG_ALL_STATIC: 1
        RUSTFLAGS: "-L native=/usr/lib/x86_64-linux-gnu -l dylib=stdc++ -l static=aom -l static=x265 -l static=dav1d -l static=de265"
      run: cargo build --release --verbose --bin phdupes

    - name: Rename and Stage
      shell: bash
      run: |
        # Version is now loaded from env
        echo "Detected version: $VERSION"

        mkdir -p staging
        cp -v "target/release/phdupes" "staging/phdupes-v${VERSION}-linux"

    - name: Publish Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.VERSION }}
        files: staging/*
        draft: false
        prerelease: false
